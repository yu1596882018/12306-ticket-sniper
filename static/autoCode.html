<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>12306 éªŒè¯ç è¯†åˆ« - æŠ¢ç¥¨ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
            max-width: 400px;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 14px;
            color: #666;
        }
        
        .tips {
            background: #e3f2fd;
            border-left: 4px solid #1890ff;
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
        }
        
        .tips strong {
            color: #1890ff;
        }

        #J-loginImg {
            width: 300px;
            height: 188px;
            border: none;
            padding: 0;
            margin: 0;
            display: inline;
        }

        #J-passCodeCoin {
            position: relative;
            width: 300px;
            height: 188px;
            margin: 0 auto 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            cursor: crosshair;
        }
        
        #J-passCodeCoin:hover {
            border-color: #1890ff;
        }

        .lgcode-active {
            position: absolute;
            z-index: 3;
            width: 27px;
            height: 27px;
            font-size: 0;
            background: url(https://kyfw.12306.cn/otn/resources/images/login/captcha.png);
            background-repeat: no-repeat;
            background-position: 0 -96px;
            cursor: pointer;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .button-group {
            display: flex;
            gap: 12px;
        }
        
        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #submit {
            background: #1890ff;
            color: white;
        }
        
        #submit:hover {
            background: #40a9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
        }
        
        #refresh {
            background: #f0f0f0;
            color: #333;
        }
        
        #refresh:hover {
            background: #e0e0e0;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸš„ éªŒè¯ç è¯†åˆ«</h1>
        <p>12306 æŠ¢ç¥¨ç³»ç»Ÿ</p>
    </div>
    
    <div class="tips">
        <strong>æ“ä½œæç¤ºï¼š</strong>ç‚¹å‡»å›¾ç‰‡ä¸­çš„æ–‡å­—ä½ç½®è¿›è¡Œé€‰æ‹©ï¼Œæœ€å¤šå¯é€‰8ä¸ªç‚¹ã€‚ç‚¹å‡»å·²é€‰ç‚¹å¯å–æ¶ˆã€‚
    </div>
    
    <div id="J-passCodeCoin">
        <img id="J-loginImg" alt="éªŒè¯ç ">
    </div>
    
    <div class="button-group">
        <button type="button" id="submit">âœ“ æäº¤éªŒè¯</button>
        <button type="button" id="refresh">â†» åˆ·æ–°</button>
    </div>
    
    <div class="footer">
        Powered by 12306 Ticket Sniper
    </div>
</div>

<script src="https://cdn.bootcss.com/axios/0.19.0/axios.min.js"></script>
<script>
    document.getElementById('J-passCodeCoin').onclick = function (e) {
        if (e.offsetY < 30) {
            return console.log('ä¸å¯ç‚¹åŒºåŸŸ');
        }

        var _this = this;
        var dom = document.createElement('div');
        dom.className = 'lgcode-active';
        dom.setAttribute('randcode', e.offsetX + ',' + (e.offsetY - 30));
        dom.style = 'top: ' + (e.offsetY - 30 + 16) + 'px; left: ' + (e.offsetX - 13) + 'px;';
        dom.onclick = function (e) {
            _this.removeChild(this);
            e.stopPropagation();
            return false;
        }
        this.appendChild(dom);
    };

    document.getElementById('submit').onclick = function (e) {
        var doms = document.getElementsByClassName('lgcode-active');
        var arr = [];
        for (var i = 0; i < doms.length; i++) {
            arr.push(doms[i].getAttribute('randcode'));
        }

        if (arr.length === 0) {
            alert('âš ï¸ è¯·å…ˆç‚¹å‡»å›¾ç‰‡é€‰æ‹©éªŒè¯ç ä½ç½®');
            return;
        }
        
        axios({
            method: 'get',
            url: '/submitCode?answer=' + arr.join(',')
        }).then(res => {
            if (res.data.result_code === 0) {
                alert('âœ… éªŒè¯æˆåŠŸï¼\n\n' + res.data.result_message + '\n\nç³»ç»Ÿå°†è‡ªåŠ¨æ›´æ–° Cookie å¹¶é‡å¯æŸ¥è¯¢ä»»åŠ¡ã€‚');
            } else {
                alert('âŒ éªŒè¯å¤±è´¥\n\n' + res.data.result_message + '\n\nè¯·ç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡è¯•ã€‚');
            }
        }, res => {
            alert('âŒ éªŒè¯å¤±è´¥ï¼Œè¯·ç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡è¯•ï¼');
        });
    };


    function getQueryVariable (variable) { // è·å–urlå‚æ•°
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        return (false);
    }

    var key = getQueryVariable('key');

    document.getElementById('refresh').onclick = function (e) {
        var doms = document.getElementsByClassName('lgcode-active');
        var container = document.getElementById('J-passCodeCoin');
        var dom = doms && doms[0];
        while (dom) {
            container.removeChild(dom);
            dom = doms && doms[0];
        }
        axios({
            method: 'get',
            url: '/refreshCode'
        }).then(res => {
            getCode(res.data);
        });
    };

    getCode(key);

    function getCode (k) {
        axios({
            method: 'get',
            url: '/getCode?key=' + k
        }).then(res => {
            console.log(res);
            document.getElementById('J-loginImg').src = 'data:image/jpg;base64,' + res.data;
        });
    }
</script>
</body>
</html>
