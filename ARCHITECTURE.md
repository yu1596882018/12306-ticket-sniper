# 项目架构文档

## 📐 系统架构

### 整体架构

12306 抢票系统采用**分层架构**设计，主要分为以下几层：

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (Application)                    │
│                     - Web 服务 (Koa)                         │
│                     - 路由管理                                │
│                     - 中间件                                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     业务层 (Business Logic)                  │
│  - 余票查询模块   - 订单提交模块   - 验证码处理模块          │
│  - Cookie 管理    - 邮件通知       - 用户状态检测            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     数据访问层 (Data Access)                 │
│  - Redis 缓存     - HTTP 请求      - 消息队列                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      外部服务 (External)                     │
│  - 12306 API      - 邮件服务       - Redis 服务              │
└─────────────────────────────────────────────────────────────┘
```

---

## 🏗️ 技术架构

### 技术栈

| 层级 | 技术 | 作用 |
|------|------|------|
| **Web 框架** | Koa 2.x | 轻量级 Web 服务框架 |
| **HTTP 客户端** | Superagent 5.x | 模拟 HTTP 请求 |
| **消息队列** | Redis Pub/Sub | 进程间通信 |
| **缓存** | Redis | Cookie、验证码缓存 |
| **邮件服务** | Nodemailer | 邮件通知 |
| **进程管理** | PM2 | 守护进程、集群 |
| **时间处理** | Moment.js | 日期时间处理 |
| **HTML 解析** | Cheerio | DOM 解析 |

### 架构特点

#### 1. 事件驱动架构
- 基于 Node.js 的异步 I/O
- 非阻塞式请求处理
- 事件循环高效调度

#### 2. 分布式设计
- Redis Pub/Sub 实现进程间通信
- 支持多进程并发抢票
- 状态信息实时同步

#### 3. 高可用性
- PM2 进程守护，自动重启
- 错误捕获与异常处理
- 登录状态自动检测

---

## 📦 模块设计

### 核心模块

```
scripts/
├── config.js           # 全局配置模块
├── localConfig.js      # 环境变量配置
├── queryList.js        # 余票查询模块 v1
├── queryList2.js       # 余票查询模块 v2
├── placeOrder.js       # 订单提交模块
├── authCookie.js       # Cookie 验证模块
├── getCodeImage.js     # 验证码获取模块
├── setCookie.js        # Cookie 设置模块
├── setHeaders.js       # 请求头设置模块
├── loopCheckUser.js    # 登录状态检测模块
├── sendmail.js         # 邮件发送模块
└── utils.js            # 工具函数模块
```

### 模块职责

#### 1. 配置模块（config.js）

**职责**：
- 管理全局配置信息
- 存储乘客信息
- 配置抢票任务参数
- 管理 Redis 连接

**核心配置**：
```javascript
{
  redisPub,           // Redis 发布客户端
  redisSub,           // Redis 订阅客户端
  redisDb,            // Redis 数据库客户端
  userCookie,         // 用户 Cookie
  userList,           // 乘客列表
  queryOptions        // 查询配置
}
```

#### 2. 余票查询模块（queryList.js / queryList2.js）

**职责**：
- 定时轮询 12306 API
- 解析余票数据
- 触发抢票流程

**工作流程**：
```
开始
  ↓
遍历日期/线路
  ↓
发起查询请求
  ↓
解析余票数据
  ↓
是否有票？
  ├─ 是 → 调用 placeOrder
  └─ 否 → 继续查询
  ↓
间隔 N 毫秒
  ↓
重复查询
```

**关键代码**：
```javascript
// 查询余票
let queryZResult = await setHeaders(
  superagent.get('https://kyfw.12306.cn/otn/leftTicket/queryZ')
).query({
  'leftTicketDTO.train_date': queryParams.queryDate,
  'leftTicketDTO.from_station': queryParams.fromCiteCode,
  'leftTicketDTO.to_station': queryParams.toCiteCode,
  purpose_codes: 'ADULT'
});
```

#### 3. 订单提交模块（placeOrder.js）

**职责**：
- 验证登录状态
- 提交订单请求
- 确认座位信息
- 查询订单结果
- 发送通知邮件

**完整流程**：
```
1. 校验登录 (checkUser)
   ↓
2. 预订订单 (submitOrderRequest)
   ↓
3. 初始化订单页 (initDc)
   ↓
4. 提取订单参数
   ↓
5. 校验订单信息 (checkOrderInfo)
   ↓
6. 查询余票数量 (getQueueCount)
   ↓
7. 确认座位 (confirmSingleForQueue)
   ↓
8. 轮询订单状态 (queryOrderWaitTime)
   ↓
9. 查询最终结果 (resultOrderForDcQueue)
   ↓
10. 发送邮件通知
```

#### 4. 验证码处理模块（getCodeImage.js / authCookie.js）

**getCodeImage.js 职责**：
- 获取验证码图片
- 存储到 Redis
- 发送邮件通知

**authCookie.js 职责**：
- 提交验证码答案
- 验证并获取新 Cookie
- 更新 Cookie 到 Redis

**验证码流程**：
```
获取验证码图片
  ↓
存储到 Redis
  ↓
生成唯一 Key
  ↓
发送邮件（包含验证链接）
  ↓
用户点击链接
  ↓
Web 页面显示验证码
  ↓
用户识别并提交
  ↓
验证通过
  ↓
更新 Cookie
  ↓
广播更新消息（Redis Pub/Sub）
  ↓
所有进程更新 Cookie
```

#### 5. Cookie 管理模块（setCookie.js / setHeaders.js）

**职责**：
- 设置请求头
- 管理 Cookie
- 模拟浏览器请求

**请求头配置**：
```javascript
{
  'User-Agent': 'Mozilla/5.0...',
  'Referer': 'https://kyfw.12306.cn/...',
  'Cookie': userCookie,
  'Content-Type': 'application/x-www-form-urlencoded'
}
```

#### 6. 登录状态检测模块（loopCheckUser.js）

**职责**：
- 定时检测登录状态
- Cookie 失效时发送通知
- 限制检测时间段（6:00-23:00）

**检测策略**：
- 每 1 分钟检测一次
- 非工作时间段不检测
- 失效立即邮件通知

#### 7. 邮件通知模块（sendmail.js / utils.js）

**职责**：
- 发送验证码邮件
- 发送抢票成功通知
- 发送登录失效提醒

**邮件类型**：
1. 验证码通知邮件（包含验证链接）
2. 抢票成功通知邮件（包含车次、日期、席别等信息）
3. Cookie 失效提醒邮件

---

## 🔄 数据流设计

### 1. 抢票主流程数据流

```
┌─────────┐
│ 定时器  │
└────┬────┘
     │
     ▼
┌─────────────────┐
│ queryList       │ 余票查询
│ - 遍历日期      │
│ - 遍历线路      │
│ - 发起请求      │
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ 12306 API       │ 官方接口
│ - leftTicket    │
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ 解析余票数据     │
│ - 是否有票？     │
└────┬────────────┘
     │
     ├─ 无票 ─┐
     │        │
     │        ▼
     │   ┌─────────┐
     │   │ 等待    │
     │   └────┬────┘
     │        │
     │◄───────┘
     │
     └─ 有票 ─┐
              │
              ▼
     ┌─────────────────┐
     │ placeOrder      │ 下单流程
     │ - checkUser     │
     │ - submitOrder   │
     │ - confirmSeat   │
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 查询订单结果     │
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 发送邮件通知     │
     └─────────────────┘
```

### 2. Cookie 管理数据流

```
┌─────────────────┐
│ 初始 Cookie      │
│ (手动配置或登录) │
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ 存储到 Redis     │ redisDb.set('userCookie', value)
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ 定时检测状态     │ loopCheckUser (每分钟)
└────┬────────────┘
     │
     ├─ 有效 ─┐
     │        │
     │        ▼
     │   ┌─────────┐
     │   │ 继续使用 │
     │   └────┬────┘
     │        │
     │◄───────┘
     │
     └─ 失效 ─┐
              │
              ▼
     ┌─────────────────┐
     │ 获取验证码       │ getCodeImage
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 邮件通知用户     │
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 用户识别验证码    │ Web 页面
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 提交验证码       │ authCookie
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 获取新 Cookie    │
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 更新 Redis       │ redisDb.set('userCookie', newValue)
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 广播更新消息     │ redisPub.publish('app', 'updateCookie')
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 所有进程监听     │ redisSub.on('message', ...)
     └────┬────────────┘
          │
          ▼
     ┌─────────────────┐
     │ 更新本地 Cookie  │
     └─────────────────┘
```

### 3. Redis Pub/Sub 消息流

```
┌───────────────┐         ┌──────────────┐
│   进程 A      │         │   Redis      │
│ (Web 服务)    │         │              │
└───────┬───────┘         └──────┬───────┘
        │                        │
        │ 1. 订阅频道             │
        │ subscribe('app')       │
        ├───────────────────────►│
        │                        │
        │                        │
┌───────┴───────┐                │
│   进程 B      │                │
│ (Worker)      │                │
└───────┬───────┘                │
        │                        │
        │ 2. 订阅频道             │
        │ subscribe('app')       │
        ├───────────────────────►│
        │                        │
        │                        │
        │ 3. 发布消息             │
        │ publish('app',         │
        │  'updateCookie')       │
        ├───────────────────────►│
        │                        │
        │                        │ 4. 广播消息
        │                        ├──────────┐
        │◄───────────────────────┤          │
        │ 5. 接收消息             │          │
        │                        │          │
┌───────┴───────┐                │          │
│ 更新 Cookie    │                │          │
└───────────────┘                │          │
                                 │          │
┌───────────────┐                │          │
│   进程 A      │◄───────────────┴──────────┘
│ 更新 Cookie    │ 6. 接收消息
└───────────────┘
```

---

## 🔐 安全设计

### 1. 敏感信息保护

**措施**：
- 使用环境变量存储敏感配置
- `.env` 文件加入 `.gitignore`
- 提供 `.env.example` 示例文件
- 身份证号等信息加密存储

### 2. Cookie 管理

**策略**：
- Cookie 存储在 Redis，不直接暴露
- 定期检测 Cookie 有效性
- 失效自动通知更新
- 多进程共享 Cookie

### 3. 请求频率控制

**限制**：
- 可配置查询间隔（建议 >= 500ms）
- 避免过于频繁请求
- 防止 IP 被封禁

---

## 🚀 性能优化

### 1. 并发处理

**策略**：
- Promise.all 并发查询多个线路
- PM2 多进程部署（-i 2）
- 异步非阻塞 I/O

### 2. 缓存优化

**实现**：
- Redis 缓存 Cookie
- Redis 缓存验证码图片
- 减少重复请求

### 3. 响应速度

**优化点**：
- 毫秒级轮询间隔
- 发现余票立即抢票
- 减少不必要的日志输出

---

## 📊 监控与日志

### 1. 日志输出

**类型**：
- 查询日志：记录每次查询结果
- 错误日志：记录异常信息
- 业务日志：记录关键业务操作

**示例**：
```javascript
console.log('无票', queryParams.queryDate + '-' + code.fromCode + '-' + code.code);
console.log('有票', queryItem);
console.log('抢票成功', options);
```

### 2. PM2 监控

**命令**：
```bash
pm2 logs        # 查看日志
pm2 monit       # 实时监控
pm2 list        # 查看进程列表
```

---

## 🔧 扩展性设计

### 1. 模块化设计

- 每个功能独立模块
- 低耦合、高内聚
- 便于维护和扩展

### 2. 配置化

- 所有参数可配置
- 支持多任务配置
- 灵活调整策略

### 3. 插件化扩展（未来）

- 通知方式扩展（微信、钉钉）
- 验证码识别扩展（AI 识别）
- 存储方式扩展（MySQL、MongoDB）

---

## 📈 未来架构演进

### 1. 微服务化

```
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ 查询服务     │  │ 订单服务     │  │ 通知服务     │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       └─────────────────┴─────────────────┘
                         │
                 ┌───────┴───────┐
                 │  消息队列     │
                 │  (RabbitMQ)   │
                 └───────────────┘
```

### 2. 容器化部署

```
┌─────────────────────────────────────┐
│         Kubernetes 集群              │
│  ┌─────┐  ┌─────┐  ┌─────┐         │
│  │ Pod │  │ Pod │  │ Pod │         │
│  └─────┘  └─────┘  └─────┘         │
│                                     │
│  ┌────────────┐  ┌────────────┐    │
│  │ Redis      │  │ RabbitMQ   │    │
│  └────────────┘  └────────────┘    │
└─────────────────────────────────────┘
```

### 3. 前后端分离

```
┌──────────────┐
│  Vue.js 前端  │  管理后台
└──────┬───────┘
       │ REST API
┌──────┴───────┐
│  Node.js 后端 │  业务逻辑
└──────┬───────┘
       │
┌──────┴───────┐
│  数据层       │  Redis + MySQL
└──────────────┘
```

---

## 🎯 设计原则

1. **单一职责**：每个模块只负责一个功能
2. **开放封闭**：对扩展开放，对修改封闭
3. **依赖倒置**：依赖抽象，不依赖具体实现
4. **最少知识**：模块间尽量减少依赖
5. **DRY 原则**：不要重复自己（Don't Repeat Yourself）

---

## 📚 参考资料

- [Node.js 官方文档](https://nodejs.org/)
- [Koa 框架文档](https://koajs.com/)
- [Redis 文档](https://redis.io/)
- [PM2 文档](https://pm2.keymetrics.io/)
- [12306 官网](https://www.12306.cn/)

---

<p align="center">
  <sub>文档版本：2.0.0 | 最后更新：2024-11-05</sub>
</p>

